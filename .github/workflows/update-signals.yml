name: Update Funding Signals

on:
  schedule:
    # Alle 5 Minuten
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install Dependencies
        run: |
          pip install requests
      
      - name: Scrape & Update signals.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO: ${{ github.repository }}
        run: |
          python << 'EOF'
          import requests
          import json
          import base64
          import re
          from datetime import datetime
          import os

          GITHUB_TOKEN = os.environ.get("GITHUB_TOKEN")
          GITHUB_REPO = os.environ.get("GITHUB_REPO")
          COINGLASS_URL = "https://www.coinglass.com/FundingRate"
          SIGNALS_FILE = "signals.json"

          TRADING_PAIRS = [
              "BTC/USDT", "ETH/USDT", "SOL/USDT", "XRP/USDT",
              "DOGE/USDT", "ADA/USDT", "AVAX/USDT", "MATIC/USDT",
          ]

          def scrape_funding_rates():
              try:
                  headers = {"User-Agent": "Mozilla/5.0"}
                  r = requests.get(COINGLASS_URL, headers=headers, timeout=15)
                  html_lower = r.text.lower()
                  signals = []

                  for pair in TRADING_PAIRS:
                      symbol = pair.split("/")[0].lower()
                      pos = html_lower.find(symbol)
                      if pos == -1:
                          continue

                      start = max(0, pos - 300)
                      end = min(len(r.text), pos + 500)
                      chunk = r.text[start:end].lower()

                      bin_pos = chunk.find("binance")
                      if bin_pos == -1:
                          bin_pos = chunk.find("okx")

                      if bin_pos != -1:
                          after_exchange = chunk[bin_pos:bin_pos+200]
                          rate_match = re.search(r'([-+]?\d+\.?\d*)\s*%', after_exchange)

                          if rate_match:
                              rate_str = rate_match.group(1)
                              try:
                                  rate_pct = float(rate_str)
                                  is_profitable = rate_pct > 0.05
                                  action = "LONG SPOT, SHORT PERP" if is_profitable else "Warte"

                                  signals.append({
                                      "pair": pair,
                                      "funding": f"{rate_pct:.3f}%",
                                      "funding_decimal": f"{rate_pct/100:.6f}",
                                      "profitable": is_profitable,
                                      "action": action,
                                      "timestamp": datetime.now().strftime("%d.%m.%Y %H:%M CET"),
                                      "exchange": "Binance"
                                  })
                              except ValueError:
                                  pass

                  return signals
              except Exception as e:
                  print(f"Scraping Error: {e}")
                  return []

          def update_github_file(signals):
              url = f"https://api.github.com/repos/{GITHUB_REPO}/contents/{SIGNALS_FILE}"
              headers = {"Authorization": f"token {GITHUB_TOKEN}"}

              # Hole aktuelle SHA
              r = requests.get(url, headers=headers)
              sha = r.json().get("sha") if r.status_code == 200 else None

              # Konvertiere zu Base64
              content_b64 = base64.b64encode(
                  json.dumps(signals, indent=2).encode('utf-8')
              ).decode('utf-8')

              payload = {
                  "message": f"Update: {datetime.now().strftime('%d.%m.%Y %H:%M CET')}",
                  "content": content_b64,
              }
              if sha:
                  payload["sha"] = sha

              r = requests.put(url, json=payload, headers=headers)
              return r.status_code in [200, 201]

          signals = scrape_funding_rates()
          if signals:
              if update_github_file(signals):
                  print(f"✓ {len(signals)} Signale aktualisiert")
              else:
                  print("✗ GitHub Update fehlgeschlagen")
          else:
              print("⚠️  Keine Signale gefunden")
          EOF
